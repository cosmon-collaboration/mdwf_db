{% include 'common/sbatch_header.j2' %}

set -euo pipefail

cd "{{ wflow_dir }}"
mkdir -p jlog

module load cpu
module load intel-mixed/2023.2.0
module load cray-fftw/3.3.10.8
module load conda
conda activate {{ conda_env }}

# On many network filesystems WAL journal mode causes SQLite disk I/O errors.
export MDWF_DB_JOURNAL="${MDWF_DB_JOURNAL:-DELETE}"

# Record job start
mdwf_db update -e {{ ensemble_id }} -o {{ operation }} -s RUNNING \
  -p "slurm_job_id=$SLURM_JOB_ID config_start={{ config_start }} config_end={{ config_end }} config_increment={{ config_inc }} glu_input={{ glu_input_path }} workdir={{ wflow_dir }} nodes={{ nodes }} smear_type={{ smear_type|default('ADAPTWFLOW_STOUT') }} smiters={{ smiters }}" \
  || true

SECONDS=0

GLU="{{ glu_exec_path }}"
STEP={{ config_inc }}
NSIM={{ nsim }}
let 'Nth={{ cpus_per_task }} / NSIM'
export OMP_NUM_THREADS=$Nth

let 'mxcnf=STEP*NSIM'
for((cnf={{ config_start }};cnf<{{ config_end }};cnf+=$mxcnf)); do
    for((i=0;i<NSIM;i++)); do
        let 'c=cnf+STEP*i'
        (( c>{{ config_end }} )) && break

        let 'lo=i*Nth/2'
        let 'hi=lo+Nth/2-1'
        let 'loh=128+i*Nth/2'
        let 'hih=loh+Nth/2-1'

        echo "Config $c: CPUs $lo-$hi $loh-$hih"
        export GOMP_CPU_AFFINITY="${lo}-${hi} ${loh}-${hih}"

        in_cfg="{{ config_dir }}/{{ config_prefix }}${c}"
        out_cfg="{{ wflow_dir }}/{{ output_prefix }}.${c}.out"
        "$GLU" -i "{{ glu_input_path }}" -c "$in_cfg" > "$out_cfg" &
    done
    wait
done

{% set operation_type = operation %}
{% include 'common/update_status.j2' %}

echo "Done in $SECONDS s"
