JOB_FAILED=${JOB_FAILED:-0}
cleanup_and_update_status() {
    local exit_code=${EXIT_CODE:-$?}
    [ -n "${JOB_FAILED:-}" ] && [ "$JOB_FAILED" -ne 0 ] 2>/dev/null && exit_code=$JOB_FAILED
    local slurm_state=""
    [ -n "$SLURM_JOB_ID" ] && slurm_state=$(sacct -j "$SLURM_JOB_ID" -n -o State --parsable2 2>/dev/null | head -1)
    [ -z "$slurm_state" ] && [ -n "$SLURM_JOB_ID" ] && slurm_state=$(scontrol show job "$SLURM_JOB_ID" 2>/dev/null | grep -o 'JobState=[^ ]*' | cut -d= -f2)
    local slurm_upper=$(echo "$slurm_state" | tr '[:lower:]' '[:upper:]' 2>/dev/null)
    local status="FAILED"
    [[ "$slurm_upper" == *"CANCEL"* ]] || [[ "$slurm_upper" == *"PREEMPT"* ]] && status="CANCELED"
    [[ "$slurm_upper" == *"COMPLETED"* ]] && [ $exit_code -eq 0 ] && status="COMPLETED"
    [ "$status" = "FAILED" ] && [ $exit_code -eq 0 ] && status="COMPLETED"
    [ "$status" = "FAILED" ] && ([ $exit_code -eq 130 ] || [ $exit_code -eq 137 ] || [ $exit_code -eq 143 ]) && status="CANCELED"
    mdwf_db update -e {{ ensemble_id }} -o {{ operation_type | default(operation) }} -s $status \
      -p "slurm_job_id=$SLURM_JOB_ID exit_code=$exit_code runtime=$SECONDS host=$(hostname) slurm_state=${slurm_state:-unknown}" || true
}
trap cleanup_and_update_status EXIT TERM INT

