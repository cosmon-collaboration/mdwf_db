# Capture exit code immediately
EXIT_CODE=$?

# Determine status based on exit code
if [ $EXIT_CODE -eq 0 ]; then
    STATUS="COMPLETED"
elif [ $EXIT_CODE -eq 130 ] || [ $EXIT_CODE -eq 137 ] || [ $EXIT_CODE -eq 143 ]; then
    STATUS="CANCELED"
else
    STATUS="FAILED"
fi

mdwf_db update -e {{ ensemble_id }} -o {{ operation_type }} -s $STATUS \
  -p "slurm_job_id=$SLURM_JOB_ID exit_code=$EXIT_CODE runtime=$SECONDS host=$(hostname)" \
  || true

exit $EXIT_CODE